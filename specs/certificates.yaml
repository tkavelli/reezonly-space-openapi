# Certificates API - 12 методов
# Управление сертификатами и шаблонами

openapi: 3.1.0
info:
  title: Certificates API
  version: 1.0.0
  description: |
    ## Certificates — 12 методов

    Раздел Certificates предназначен для управления PDF сертификатами, которые выдаются пользователям за прохождение курсов. Система поддерживает шаблоны сертификатов, массовую и индивидуальную выдачу, а также интеграцию с внешними системами верификации.

    Certificate представляет собой PDF документ, подтверждающий успешное завершение обучения. Каждый сертификат имеет уникальный номер, дату выдачи и может быть проверен через публичный интерфейс.

tags:
  - name: Certificates.Templates
    description: |
      Управление шаблонами для генерации PDF сертификатов: внешний вид, расположение элементов и переменные для подстановки данных (read-only).
  - name: Certificates.Issued
    description: |
      Управление выданными сертификатами, их статусами и верификацией.
  - name: Certificates.Lookups
    description: |
      Справочники и системные настройки, связанные с сертификатами.

paths:
  # === Certificates.Templates ===

  /certificate/template/index:
    get:
      operationId: listCertificateTemplates
      tags: [Certificates.Templates]
      summary: Получить список шаблонов сертификатов
      description: Возвращает все доступные шаблоны для генерации сертификатов
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Page'
        - $ref: './core/common/parameters.yaml#/components/parameters/PerPage'
        - name: active_only
          in: query
          required: false
          schema:
            type: boolean
            default: true
          description: Показать только активные шаблоны
      responses:
        '200':
          description: List of certificate templates
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          pagination:
                            $ref: './core/common/schemas.yaml#/components/schemas/PaginationMeta'
                          items:
                            type: array
                            items:
                              $ref: './core/common/schemas.yaml#/components/schemas/CertificateTemplate'
              examples:
                templates_page:
                  summary: Список активных шаблонов
                  value:
                    success: true
                    data:
                      pagination:
                        total: 2
                        page: 1
                        per_page: 20
                      items:
                        - id: 1
                          name: "Default Blue"
                          description: "Базовый синий шаблон"
                          preview_url: "https://cdn.space/templates/1/preview.png"
                          active: true
                          created_at: "2024-10-01T12:00:00Z"
                          updated_at: "2024-11-01T08:00:00Z"
                        - id: 2
                          name: "Gold Award"
                          description: "Золотой шаблон для VIP выпусков"
                          preview_url: "https://cdn.space/templates/2/preview.png"
                          active: true
                          created_at: "2024-10-05T09:00:00Z"
                          updated_at: "2024-11-02T10:00:00Z"

  /certificate/template/view:
    get:
      operationId: getCertificateTemplate
      tags: [Certificates.Templates]
      summary: Получить детальную информацию о шаблоне сертификата
      description: Возвращает полную информацию о шаблоне включая переменные и предпросмотр
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Id'
      responses:
        '200':
          description: Certificate template details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          id:
                            type: integer
                          name:
                            type: string
                          description:
                            type: string
                          template_html:
                            type: string
                          variables:
                            type: array
                            items:
                              type: object
                              properties:
                                name:
                                  type: string
                                type:
                                  type: string
                                description:
                                  type: string
                                required:
                                  type: boolean
                          preview_url:
                            type: string
                          active:
                            type: boolean
              examples:
                template_detail:
                  summary: Детальный шаблон
                  value:
                    success: true
                    data:
                      id: 2
                      name: "Gold Award"
                      description: "Золотой шаблон для VIP выпусков"
                      template_html: "<html>...шаблон...</html>"
                      variables:
                        - name: "username"
                          type: "string"
                          description: "Имя студента"
                          required: true
                        - name: "course_title"
                          type: "string"
                          required: true
                      preview_url: "https://cdn.space/templates/2/preview.png"
                      active: true
        '404':
          description: Template not found
          $ref: './core/common/responses.yaml#/components/responses/NotFound'

  /certificate/template/preview:
    post:
      operationId: createCertificateTemplatePreview
      tags: [Certificates.Templates]
      summary: Сгенерировать превью сертификата
      description: Генерирует превью сертификата по шаблону с тестовыми данными
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [template_id]
              properties:
                template_id:
                  type: integer
                  minimum: 1
                  description: ID шаблона сертификата
                test_data:
                  type: object
                  description: Тестовые данные для подстановки в шаблон
                  properties:
                    student_name:
                      type: string
                      default: "Иван Иванов"
                    course_name:
                      type: string
                      default: "Тестовый курс"
                    completion_date:
                      type: string
                      default: "2024-01-15"
                    certificate_number:
                      type: string
                      default: "CERT-2024-001"
            examples:
              preview_request:
                summary: Превью шаблона с тестовыми данными
                value:
                  template_id: 2
                  test_data:
                    student_name: "Иван Иванов"
                    course_name: "Онбординг"
                    completion_date: "2024-01-15"
                    certificate_number: "CERT-2024-001"
      responses:
        '200':
          description: Certificate preview generated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          preview_url:
                            type: string
                            format: uri
                          pdf_url:
                            type: string
                            format: uri
              examples:
                preview_generated:
                  summary: Превью готово
                  value:
                    success: true
                    data:
                      preview_url: "https://cdn.space/templates/2/preview.png"
                      pdf_url: "https://cdn.space/templates/2/preview.pdf"

  # === Certificates.Issued ===

  /certificate/certificate/index:
    get:
      operationId: listCertificates
      tags: [Certificates.Issued]
      summary: Получить список выданных сертификатов
      description: Возвращает список выданных сертификатов с фильтрацией
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Page'
        - $ref: './core/common/parameters.yaml#/components/parameters/PerPage'
        - name: user_id
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
          description: Фильтр по ID пользователя
        - name: course_id
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
          description: Фильтр по ID курса
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [issued, revoked, expired]
          description: Фильтр по статусу сертификата
        - name: date_from
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Дата выдачи от
        - name: date_to
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Дата выдачи до
      responses:
        '200':
          description: List of issued certificates
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          pagination:
                            $ref: './core/common/schemas.yaml#/components/schemas/PaginationMeta'
                          items:
                            type: array
                            items:
                              $ref: './core/common/schemas.yaml#/components/schemas/Certificate'
              examples:
                list:
                  summary: Список сертификатов с фильтрами
                  value:
                    success: true
                    data:
                      pagination:
                        total: 2
                        page: 1
                        per_page: 20
                      items:
                        - id: 9001
                          number: "CERT-2025-0001"
                          user_id: 123
                          course_id: 456
                          template_id: 2
                          status: "issued"
                          issued_at: "2025-02-11T09:00:00Z"
                        - id: 9002
                          number: "CERT-2025-0002"
                          user_id: 140
                          course_id: 480
                          template_id: 3
                          status: "issued"
                          issued_at: "2025-02-12T11:00:00Z"

  /certificate/certificate/view:
    get:
      operationId: getCertificate
      tags: [Certificates.Issued]
      summary: Получить информацию о выданном сертификате
      description: Возвращает детальную информацию о конкретном выданном сертификате
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Id'
      responses:
        '200':
          description: Certificate details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: './core/common/schemas.yaml#/components/schemas/CertificateDetail'
              examples:
                detail:
                  summary: Детальный сертификат
                  value:
                    success: true
                    data:
                      id: 9001
                      number: "CERT-2025-0001"
                      user:
                        id: 123
                        username: "Иван Иванов"
                        email: "ivan@example.com"
                      course:
                        id: 456
                        name: "Онбординг"
                      template_id: 2
                      status: "issued"
                      pdf_url: "https://cdn.space/certificates/9001.pdf"
                      verification_url: "https://verify.space/CERT-2025-0001"
                      issued_at: "2025-02-11T09:00:00Z"
                      expires_at: "2026-02-11T09:00:00Z"
        '404':
          description: Certificate not found
          $ref: './core/common/responses.yaml#/components/responses/NotFound'

  /certificate/certificate/create:
    post:
      operationId: createCertificate
      tags: [Certificates.Issued]
      summary: Выдать сертификат
      description: Выдает новый сертификат пользователю за прохождение курса
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id, course_id, template_id]
              properties:
                user_id:
                  type: integer
                  minimum: 1
                  description: ID пользователя
                course_id:
                  type: integer
                  minimum: 1
                  description: ID курса
                template_id:
                  type: integer
                  minimum: 1
                  description: ID шаблона сертификата
                issue_date:
                  type: string
                  format: date
                  description: Дата выдачи (по умолчанию текущая)
                expires_at:
                  type: string
                  format: date
                  description: Дата истечения (необязательно)
                custom_data:
                  type: object
                  description: Дополнительные данные для шаблона
            examples:
              issue_single:
                summary: Выдача сертификата студенту
                value:
                  user_id: 123
                  course_id: 456
                  template_id: 2
                  issue_date: "2024-01-15"
                  expires_at: "2025-01-15"
                  custom_data:
                    username: "Иван Иванов"
                    course_title: "Онбординг"
      responses:
        '200':
          description: Certificate issued
          content:
            application/json:
              schema:
                $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
              examples:
                issued:
                  summary: Сертификат выдан
                  value:
                    success: true
                    message: "Certificate created"
        '400':
          description: Validation error
          $ref: './core/common/responses.yaml#/components/responses/ValidationError'

  /certificate/certificate/revoke:
    post:
      tags: [Certificates.Issued]
      summary: Отозвать сертификат
      description: Отзывает ранее выданный сертификат
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [certificate_id, reason]
              properties:
                certificate_id:
                  type: integer
                  minimum: 1
                  description: ID сертификата для отзыва
                reason:
                  type: string
                  description: Причина отзыва сертификата
      responses:
        '200':
          description: Certificate revoked successfully
          $ref: './core/common/responses.yaml#/components/responses/Success'
        '400':
          description: Bad request
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'
        '404':
          description: Certificate not found
          $ref: './core/common/responses.yaml#/components/responses/NotFound'

  /certificate/certificate/verify:
    get:
      tags: [Certificates.Issued]
      summary: Проверить подлинность сертификата
      description: Проверяет сертификат по номеру или QR коду
      parameters:
        - name: number
          in: query
          required: false
          schema:
            type: string
          description: Номер сертификата
        - name: code
          in: query
          required: false
          schema:
            type: string
          description: Проверочный код из QR кода
      responses:
        '200':
          description: Certificate verification result
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          valid:
                            type: boolean
                            description: Сертификат действителен
                          certificate:
                            $ref: './core/common/schemas.yaml#/components/schemas/Certificate'
        '400':
          description: Bad request
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'
        '404':
          description: Сертификат не найден или недействителен

  /certificate/certificate/download:
    get:
      operationId: downloadCertificate
      tags: [Certificates.Issued]
      summary: Скачать PDF сертификата
      description: Возвращает PDF файл сертификата для скачивания
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Id'
      responses:
        '200':
          description: PDF certificate file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
              examples:
                pdf_file:
                  summary: PDF сертификата
                  value: "UEsDBBQACAgI..."  # base64 заглушка
        '404':
          description: Certificate not found
          $ref: './core/common/responses.yaml#/components/responses/NotFound'

  /certificate/download-zip:
    post:
      operationId: downloadCertificatesZip
      tags: [Certificates.Issued]
      summary: Сформировать ZIP с сертификатами
      description: |
        Запускает генерацию ZIP-архива сертификатов по фильтрам (search, course_id, user_id, пагинация, сортировка). Одновременно может быть только одна активная задача на ключ.

        **Назначение:** массовая выгрузка сертификатов для передачи внешним системам или печати.

        **Пример Use case:** администратор выбирает курс и диапазон пользователей, запускает экспорт и получает ссылку на архив.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                search:
                  type: string
                course_id:
                  type: integer
                  minimum: 1
                user_id:
                  type: integer
                  minimum: 1
                page:
                  type: integer
                  minimum: 1
                  default: 1
                per-page:
                  type: integer
                  minimum: 1
                  maximum: 500
                  default: 50
                sort:
                  type: string
                  example: -created_at
            examples:
              download_zip_request:
                summary: Экспорт сертификатов по курсу
                value:
                  course_id: 456
                  page: 1
                  per-page: 100
                  sort: -issued_at
      responses:
        '200':
          description: Задача запущена
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      message:
                        type: string
                        example: "Commit job queued"
                      data:
                        type: object
                        properties:
                          filePath:
                            type: string
                            format: uri
                            example: /uploads/certificates/zip/abc.zip
              examples:
                download_zip_queued:
                  summary: Задача на экспорт создана
                  value:
                    success: true
                    message: "Commit job queued"
                    data:
                      filePath: "/uploads/certificates/zip/certificates-2025-02-11.zip"
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'
  /certificate/certificate/bulk-issue:
    post:
      tags: [Certificates.Issued]
      summary: Массовая выдача сертификатов
      description: Выдает сертификаты группе пользователей за курс
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_ids, course_id, template_id]
              properties:
                user_ids:
                  type: array
                  items:
                    type: integer
                    minimum: 1
                  maxItems: 100
                  description: Массив ID пользователей
                course_id:
                  type: integer
                  minimum: 1
                  description: ID курса
                template_id:
                  type: integer
                  minimum: 1
                  description: ID шаблона сертификата
                issue_date:
                  type: string
                  format: date
                  description: Дата выдачи
      responses:
        '200':
          description: Bulk issue results
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          batch_id:
                            type: string
                          total_issued:
                            type: integer
                          failed:
                            type: array
                            items:
                              type: object
                              properties:
                                user_id:
                                  type: integer
                                error:
                                  type: string

  # === Certificates.Lookups ===

  /dictionary/certificate/statuses:
    get:
      tags: [Certificates.Lookups]
      summary: Получить статусы сертификатов
      description: Возвращает все возможные статусы сертификатов в системе
      responses:
        '200':
          description: List of certificate statuses
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              example: issued
                            name:
                              type: string
                              example: "Выдан"
                            description:
                              type: string
                              example: "Сертификат успешно выдан"

  /certificate/settings:
    get:
      tags: [Certificates.Lookups]
      summary: Получить настройки модуля сертификатов
      description: Возвращает системные настройки для генерации сертификатов
      responses:
        '200':
          description: Certificate module settings
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          auto_issue_enabled:
                            type: boolean
                            example: true
                          default_template_id:
                            type: integer
                            example: 2
                          verification_url_template:
                            type: string
                            example: "https://verify.space/{number}"
                          storage_settings:
                            type: object
                            properties:
                              provider:
                                type: string
                                example: "s3"
                              bucket:
                                type: string
                                example: "space-certificates"

  /certificate/course/index:
    get:
      operationId: listCertificateCourses
      tags: [Certificates.Lookups]
      summary: Список курсов для выдачи сертификатов
      description: Возвращает курсы (id, title, type) для выбора `course_id` при выдаче сертификатов.
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Page'
        - $ref: './core/common/parameters.yaml#/components/parameters/PerPage'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          pagination:
                            $ref: './core/common/schemas.yaml#/components/schemas/PaginationMeta'
                          items:
                            type: array
                            items:
                              type: object
                              properties:
                                id:
                                  type: integer
                                  example: 12
                                title:
                                  type: string
                                  example: "Онбординг"
                                type:
                                  type: string
                                  example: "course"
              examples:
                courses_page:
                  summary: Курсы для выбора сертификата
                  value:
                    success: true
                    data:
                      pagination:
                        total: 2
                        page: 1
                        per_page: 20
                      items:
                        - id: 12
                          title: "Онбординг"
                          type: "course"
                        - id: 18
                          title: "Менторская программа"
                          type: "program"

  /certificate/user/index:
    get:
      operationId: listCertificateUsers
      tags: [Certificates.Lookups]
      summary: Список пользователей для выдачи сертификатов
      description: Возвращает пользователей (id, username, email) для выбора `user_id` при выдаче сертификатов.
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Page'
        - $ref: './core/common/parameters.yaml#/components/parameters/PerPage'
        - name: search
          in: query
          schema:
            type: string
          description: Поиск по имени/email
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          pagination:
                            $ref: './core/common/schemas.yaml#/components/schemas/PaginationMeta'
                          items:
                            type: array
                            items:
                              type: object
                              properties:
                                id:
                                  type: integer
                                  example: 101
                                username:
                                  type: string
                                  example: "Иван Иванов"
                                email:
                                  type: string
                                  example: "ivan@example.com"
              examples:
                users_page:
                  summary: Пользователи для выдачи
                  value:
                    success: true
                    data:
                      pagination:
                        total: 2
                        page: 1
                        per_page: 20
                      items:
                        - id: 101
                          username: "Иван Иванов"
                          email: "ivan@example.com"
                        - id: 102
                          username: "Мария Петрова"
                          email: "maria@example.com"

  /certificate/type/index:
    get:
      operationId: listCertificateTypes
      tags: [Certificates.Lookups]
      summary: Справочник типов сертификатов
      description: Возвращает список типов сертификатов для подстановки в запросах выдачи.
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          pagination:
                            $ref: './core/common/schemas.yaml#/components/schemas/PaginationMeta'
                          items:
                            type: array
                            items:
                              type: object
                              properties:
                                id:
                                  type: integer
                                  example: 1
                                name:
                                  type: string
                                  example: Course completion
                                description:
                                  type: string
                                  nullable: true
                                  example: "Выдаётся за прохождение курса"
              examples:
                certificate_types:
                  summary: Доступные типы сертификатов
                  value:
                    success: true
                    data:
                      pagination:
                        total: 2
                        page: 1
                        per_page: 20
                      items:
                        - id: 1
                          name: "Course completion"
                          description: "Выдаётся за прохождение курса"
                        - id: 2
                          name: "Exam"
                          description: "Выдаётся за сдачу экзамена"

  /certificate/variable/index:
    get:
      operationId: listCertificateVariables
      tags: [Certificates.Lookups]
      summary: Список переменных сертификатов
      description: Возвращает доступные переменные для шаблонов сертификатов (ключ, имя, обязательность).
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          pagination:
                            $ref: './core/common/schemas.yaml#/components/schemas/PaginationMeta'
                          items:
                            type: array
                            items:
                              type: object
                              properties:
                                id:
                                  type: integer
                                  example: 5
                                key:
                                  type: string
                                  example: username
                                name:
                                  type: string
                                  example: Имя пользователя
                                description:
                                  type: string
                                  nullable: true
                                  example: "Отображается на сертификате"
                                required:
                                  type: boolean
                                  example: true
              examples:
                certificate_variables:
                  summary: Переменные для шаблонов
                  value:
                    success: true
                    data:
                      pagination:
                        total: 2
                        page: 1
                        per_page: 20
                      items:
                        - id: 5
                          key: username
                          name: "Имя пользователя"
                          description: "Отображается на сертификате"
                          required: true
                        - id: 6
                          key: course_title
                          name: "Название курса"
                          required: true

  /certificate/variable-list/index:
    get:
      operationId: listCertificateVariableValues
      tags: [Certificates.Lookups]
      summary: Наборы переменных сертификатов
      description: Возвращает значения переменных (variable_id, key, value) для подстановки в шаблоны.
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          pagination:
                            $ref: './core/common/schemas.yaml#/components/schemas/PaginationMeta'
                          items:
                            type: array
                            items:
                              type: object
                              properties:
                                variable_id:
                                  type: integer
                                  example: 5
                                key:
                                  type: string
                                  example: username
                                value:
                                  type: string
                                  example: "Иван Иванов"
              examples:
                certificate_variable_values:
                  summary: Значения переменных
                  value:
                    success: true
                    data:
                      pagination:
                        total: 2
                        page: 1
                        per_page: 20
                      items:
                        - variable_id: 5
                          key: username
                          value: "Иван Иванов"
                        - variable_id: 6
                          key: course_title
                          value: "Онбординг"
