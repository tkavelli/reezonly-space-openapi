# Users Management API - 16 методов
# Полный User Management блок из 45 приоритетных методов

openapi: 3.1.0
info:
  title: Users Management API
  version: 1.0.0
  description: |
    ## User Management — 16 методов

    Раздел User Management предназначен для синхронизации пользователей между вашей CRM/ERP и платформой Space. Каждый пользователь имеет профиль с контактной информацией, роль доступа, статус и может быть участником групп и курсов.

    User представляет пользователя в системе Reezonly Space. Каждый пользователь имеет профиль с контактной информацией, роль доступа, статус и может быть участником групп и курсов.

tags:
  - name: Users.Operations
    description: |
      ## Операции с пользователями

      **Назначение:** централизованно создать, прочитать, обновить и удалить пользователей, сохраняя синхронизацию с LMS и бизнес-ролями.
      **Ключевые особенности:**
      - Протоколированная магистраль CRUD по `X-API-Key` с фильтрами/пагинацией.
      - Полный сет схем `SuccessResponse`, `BadRequest`, `Forbidden`, `NotFound`, и `User`.
      - Поддержка массовых операций (`delete?ids[]=`) и отдельных просмотров.
      **Пример Use case:** интегратор CRM запрашивает `/user/user/index` для списка, показывает карточку и вызывает `PUT /user/user/update`, чтобы синхронно обновить кастомные поля и статусы.
  - name: Users.Courses
    description: |
      ## Управление доступом пользователей к курсам

      **Назначение:** быстро назначать/отзывать доступ к курсам из внешней LMS/CRM.
      **Ключевые особенности:** набор `POST /add-course`/`POST /delete-course` с телом `user_id` + `course_ids`, проверка доступности и массовые обновления.
      **Пример Use case:** маркетолог настраивает доступ студентов к новому продукту: сначала назначает нужный набор курсов, затем отзывает старые.
  - name: Users.Import
    description: |
      ## Импорт пользователей

      **Назначение:** загружать сотни пользователей и отслеживать прогресс асинхронно.
      **Ключевые особенности:** предварительный `preview` (multipart с шаблоном), `load` создаёт задачу, `get-import-progress` возвращает `ImportStatus`, дополнительные отчёты XLSX.
      **Пример Use case:** после оплаты клиент загружает Excel, смотрит превью, запускает импорт и регулярно проверяет статус, пока не получит финальный файл через `/user/importreport/download`.
  - name: Users.Fields
    description: |
      ## Кастомные поля пользователей

      **Назначение:** предоставлять актуальные метаданные профиля (customer attributes, achievements, tokens).
      **Ключевые особенности:** простой список полей `/dictionary/user/fields`, возвращаемая схема `UserField`.
      **Пример Use case:** мобильное приложение запрашивает доступные поля, чтобы показать динамическую форму регистрации с нужными полями и валидацией.

paths:
  # === Users.Operations ===

  /user/user/index:
    get:
      tags: [Users.Operations]
      operationId: listUsers
      summary: Получить список всех пользователей
      description: Возвращает список всех пользователей с фильтрацией, сортировкой и пагинацией
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Page'
        - $ref: './core/common/parameters.yaml#/components/parameters/PerPage'
        - $ref: './core/common/parameters.yaml#/components/parameters/Search'
      responses:
        '200':
          description: Список пользователей успешно получен
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - $ref: '#/components/schemas/UserList'
              examples:
                default:
                  summary: Пагинированный список пользователей
                  value:
                    success: true
                    data:
                      pagination:
                        total: 1520
                        page: 1
                        per_page: 20
                      items:
                        - id: 137
                          email: user@example.com
                          username: "Иван Иванов"
                          role: student
                          status: active
                          created_at: "2024-01-15T10:30:00Z"
                          updated_at: "2024-02-01T09:10:00Z"
                        - id: 138
                          email: admin@example.com
                          username: "Мария Админова"
                          role: admin
                          status: active
                          created_at: "2024-01-12T08:00:00Z"
                          updated_at: "2024-02-02T12:00:00Z"
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'

  /user/user/admin:
    get:
      tags: [Users.Operations]
      operationId: listAdminUsers
      summary: Получить список администраторов
      description: Возвращает список всех пользователей с правами администратора
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Page'
        - $ref: './core/common/parameters.yaml#/components/parameters/PerPage'
      responses:
        '200':
          description: Список администраторов успешно получен
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - $ref: '#/components/schemas/UserList'
              examples:
                default:
                  summary: Только пользователи с ролями админа
                  value:
                    success: true
                    data:
                      pagination:
                        total: 2
                        page: 1
                        per_page: 50
                      items:
                        - id: 5
                          email: "cto@example.com"
                          username: "Сергей Техдир"
                          role: admin
                          status: active
                          created_at: "2023-10-10T07:00:00Z"
                          updated_at: "2024-02-02T11:00:00Z"
                        - id: 7
                          email: "owner@example.com"
                          username: "Анна Владельцева"
                          role: admin
                          status: active
                          created_at: "2023-09-01T09:30:00Z"
                          updated_at: "2024-02-03T09:15:00Z"
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'
        '403':
          $ref: './core/common/responses.yaml#/components/responses/Forbidden'

  /user/user/view:
    get:
      tags: [Users.Operations]
      operationId: getUser
      summary: Получить детальную информацию о пользователе
      description: Возвращает полную информацию о пользователе включая его группы, курсы и кастомные поля
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Id'
      responses:
        '200':
          description: Успешно получена информация о пользователе
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          item:
                            $ref: './core/common/schemas.yaml#/components/schemas/User'
              examples:
                default:
                  summary: Карточка пользователя с группами и курсами
                  value:
                    success: true
                    data:
                      item:
                        id: 137
                        username: "Иван Иванов"
                        email: "user@example.com"
                        role: student
                        status: active
                        department: "Продажи"
                        position: "Менеджер"
                        custom_fields:
                          city: "Москва"
                          experience_years: 3
                        groups:
                          - id: 12
                            name: "Sales / B2B"
                          - id: 18
                            name: "Москва"
                        courses:
                          - id: 501
                            title: "Онбординг"
                          - id: 502
                            title: "CRM Advanced"
                        created_at: "2024-01-15T10:30:00Z"
                        updated_at: "2024-02-01T09:10:00Z"
        '404':
          $ref: './core/common/responses.yaml#/components/responses/NotFound'

  /dictionary/user/fields:
    get:
      tags: [Users.Fields]
      operationId: listUserFields
      summary: Получить список кастомных полей пользователя
      description: Возвращает все доступные кастомные поля профилей пользователей
      responses:
        '200':
          description: Успешно получен список кастомных полей
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/UserField'
              examples:
                default:
                  summary: Справочник пользовательских полей
                  value:
                    success: true
                    items:
                      - id: 789
                        name: "experience_years"
                        label: "Опыт работы (лет)"
                        type: number
                        required: false
                        enabled: true
                        validation_rules:
                          min: 0
                          max: 50
                        options: []
                      - id: 790
                        name: "city"
                        label: "Город"
                        type: string
                        required: false
                        enabled: true
                        validation_rules: {}
                        options: []
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'
        '403':
          $ref: './core/common/responses.yaml#/components/responses/Forbidden'

  /user/user/create:
    post:
      tags: [Users.Operations]
      operationId: createUser
      summary: Создать нового пользователя
      description: |
        Создает нового пользователя в системе с возможностью назначения роли.
        Автоматически синхронизирует пользователя с LMS и отправляет уведомления.

        **Валидация:**
        - Email должен быть уникальным в системе
        - Username обязателен, минимальная длина 2 символа, максимальная 255
        - Роль должна существовать в системе (не из списка RESTRICTED_ROLES)
        - Проверяется лимит пользователей тарифа

        **Бизнес-логика:**
        - При создании администратора отправляется email с паролем
        - Для обычных пользователей также отправляется уведомление
        - Автоматическая синхронизация с LMS через очередь
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/UserForm'
            examples:
              basic_user:
                summary: Создание обычного пользователя
                value:
                  username: "Иван Петров"
                  email: "ivan.petrov@example.com"
                  department: "IT отдел"
                  position: "Разработчик"
              admin_user:
                summary: Создание администратора
                value:
                  username: "Мария Сидорова"
                  email: "maria.sidorова@example.com"
                  role: "admin"
                  password: "SecurePassword123!"
      responses:
        '201':
          description: Пользователь успешно создан
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user_id:
                            type: integer
                            example: 123
              examples:
                user_created:
                  summary: Пользователь создан
                  value:
                    success: true
                    data:
                      user_id: 123
        '400':
          description: Ошибка валидации
          content:
            application/json:
              schema:
                $ref: './core/common/schemas.yaml#/components/schemas/ErrorResponse'
              examples:
                validation_error:
                  summary: Ошибка валидации email
                  value:
                    success: false
                    errors:
                      email: ["Email адрес уже занят"]
                user_limit_error:
                  summary: Достигнут лимит пользователей
                  value:
                    success: false
                    errors:
                      username: ["New user registration is not available"]
        '403':
          description: Недостаточно прав для создания пользователя
          content:
            application/json:
              schema:
                $ref: './core/common/schemas.yaml#/components/schemas/ErrorResponse'
              example:
                success: false
                errors:
                  permission: ["Insufficient permissions"]

  /user/user/update:
    put:
      tags: [Users.Operations]
      operationId: updateUser
      summary: Обновить данные пользователя
      description: Обновляет информацию о существующем пользователе
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Id'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/UserForm'
            examples:
              update_profile:
                summary: Обновление профиля и статуса
                value:
                  username: "Ирина Климова"
                  status: "active"
                  role: "editor"
                  department: "Маркетинг"
                  position: "Контент-редактор"
              update_memberships:
                summary: Обновление групп и курсов
                value:
                  group_ids: [12, 18]
                  course_ids: [501, 550]
      responses:
        '200':
          description: Пользователь обновлён
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user_id:
                            type: integer
                            example: 123
              examples:
                updated:
                  summary: Обновление роли и статуса
                  value:
                    success: true
                    data:
                      user_id: 123
        '400':
          $ref: './core/common/responses.yaml#/components/responses/ValidationError'
        '404':
          $ref: './core/common/responses.yaml#/components/responses/NotFound'

  /user/user/delete:
    delete:
      tags: [Users.Operations]
      operationId: deleteUser
      summary: Удалить пользователей
      description: Удаляет одного или нескольких пользователей
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Ids'
      responses:
        '200':
          description: Пользователь(и) удалены
          content:
            application/json:
              schema:
                $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
              examples:
                bulk_delete:
                  summary: Удалено несколько пользователей
                  value:
                    success: true
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'

  /dictionary/user/statuses:
    get:
      tags: [Users.Operations]
      operationId: listUserStatuses
      summary: Получить расширенные статусы пользователей
      description: Возвращает все возможные статусы пользователей в системе
      responses:
        '200':
          description: Успешно получен список статусов пользователей
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/UserStatus'
              examples:
                default:
                  summary: Справочник статусов
                  value:
                    success: true
                    items:
                      - id: active
                        name: "Активный"
                        description: "Полный доступ к платформе"
                        category: "access"
                        color: "#2ea44f"
                        is_default: true
                      - id: inactive
                        name: "Неактивный"
                        description: "Нет доступа, архив"
                        category: "access"
                        color: "#9ca3af"
                        is_default: false
                      - id: blocked
                        name: "Заблокирован"
                        description: "Доступ закрыт администратором"
                        category: "blocked"
                        color: "#ef4444"
                        is_default: false
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'
        '403':
          $ref: './core/common/responses.yaml#/components/responses/Forbidden'

  # === Users.Courses ===

  /user/user/add-course:
    post:
      tags: [Users.Courses]
      operationId: assignUserCourse
      summary: Назначить курсы пользователям
      description: Массово назначает курсы списку пользователей
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userIds, courses]
              properties:
                userIds:
                  type: array
                  minItems: 1
                  items:
                    type: integer
                    minimum: 1
                  description: Список ID пользователей для назначения
                  example: [123, 124]
                courses:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [id]
                    properties:
                      id:
                        type: integer
                        minimum: 1
                        description: ID курса
                        example: 501
                      learning_group_id:
                        type: integer
                        minimum: 1
                        description: ID учебной группы (если назначается в конкретную группу)
                        example: 10
                      group_name:
                        type: string
                        description: Название группы, если группы ещё нет
                        example: "Support"
                  description: Список курсов для назначения, с опциональной привязкой к учебной группе или имени группы
            examples:
              assign_courses:
                summary: Массовое назначение курсов двум пользователям
                value:
                  userIds: [123, 124]
                  courses:
                    - id: 501
                      learning_group_id: 10
                    - id: 550
                      group_name: "Support"
      responses:
        '200':
          description: Курсы назначены
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  results:
                    type: array
                    description: Результат по каждому назначению
                    items:
                      type: object
                      properties:
                          userId:
                            type: integer
                            example: 501
                          courseId:
                            type: integer
                            example: 901
                          result:
                            type: boolean
                            example: true
                          new:
                            type: boolean
                            example: false
              examples:
                assigned:
                  summary: Успешное назначение
                  value:
                    success: true
                    results:
                      - userId: 123
                        courseId: 501
                        result: true
                        new: true
                      - userId: 124
                        courseId: 550
                        result: true
                        new: false
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'

  /user/user/delete-course:
    post:
      tags: [Users.Courses]
      operationId: deleteUserCourse
      summary: Отозвать доступ к курсам у пользователей
      description: Массово отзывает доступ к курсам у списка пользователей
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userIds, courses]
              properties:
                userIds:
                  type: array
                  minItems: 1
                  items:
                    type: integer
                    minimum: 1
                  description: Список ID пользователей для отзыва
                  example: [123, 124]
                courses:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [id]
                    properties:
                      id:
                        type: integer
                        minimum: 1
                        description: ID курса
                        example: 501
                      learning_group_id:
                        type: integer
                        minimum: 1
                        description: ID учебной группы (если нужно отозвать только в группе)
                        example: 10
                      group_name:
                        type: string
                        description: Название группы, если отозвать по имени
                        example: "Support"
                  description: Список курсов для отзыва, с опциональной привязкой к учебной группе или имени группы
            examples:
              revoke_courses:
                summary: Отзыв курсов у нескольких пользователей
                value:
                  userIds: [123, 124]
                  courses:
                    - id: 501
                      learning_group_id: 10
                    - id: 550
                      group_name: "Support"
      responses:
        '200':
          description: Курсы отозваны
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  results:
                    oneOf:
                      - type: array
                        items:
                          type: object
                          properties:
                            userId:
                              type: integer
                              example: 501
                            courseId:
                              type: integer
                              example: 901
                            result:
                              type: boolean
                              example: true
                      - type: integer
                        description: Количество удалённых записей
              examples:
                revoked:
                  summary: Успешный отзыв
                  value:
                    success: true
                    results: 2
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'

# === Users.Import ===

  /user/user/preview:
    post:
      tags: [Users.Import]
      operationId: getUserImportPreview
      summary: Предпросмотр импорта Excel-файла
      description: Анализирует Excel файл и показывает preview данных для импорта
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [fileImport]
              properties:
                fileImport:
                  type: string
                  format: binary
                  description: Excel файл для импорта (.xlsx, .xls)
                updateMode:
                  type: boolean
                  description: Обновлять существующих пользователей
                  example: false
            examples:
              sample_file:
                summary: Excel с 3 пользователями
                value:
                  fileImport: "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,UEsDBBQA..."
                  updateMode: false
      responses:
        '200':
          description: Успешно проанализирован файл
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          preview:
                            type: object
              examples:
                preview_ok:
                  summary: Валидный файл, без ошибок
                  value:
                    success: true
                    data:
                      preview:
                        total_rows: 3
                        valid_rows: 3
                        errors: []
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'

  /user/user/load:
    post:
      tags: [Users.Import]
      operationId: createUserImport
      summary: Запустить импорт пользователей (асинхронно)
      description: Запускает фоновый процесс импорта пользователей из Excel файла
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [fileImport]
              properties:
                fileImport:
                  type: string
                  format: binary
                  description: Excel файл для импорта
                updateMode:
                  type: boolean
                  default: false
                  description: Обновлять существующих пользователей
                  example: true
            examples:
              start_import:
                summary: Импорт с обновлением существующих пользователей
                value:
                  fileImport: "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,UEsDBBQA..."
                  updateMode: true
      responses:
        '200':
          description: Импорт успешно запущен
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          jobId:
                            type: integer
                            example: 1201
                          reportKey:
                            type: string
                            example: "import-users-2025-02-10.xlsx"
              examples:
                import_started:
                  summary: Импорт принят и обрабатывается
                  value:
                    success: true
                    message: "Commit job queued"
                    data:
                      jobId: 1024
                      reportKey: "imp-2025-02-10-001"
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'

  /user/user/get-import-progress:
    get:
      tags: [Users.Import]
      operationId: getUserImportProgress
      summary: Получить статус текущего импорта
      description: Возвращает текущий статус и прогресс импорта пользователей
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            example: "imp-2025-02-10-001"
          description: ID импорта (из ответа метода load)
      responses:
        '200':
          description: Успешно получен статус импорта
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          progress:
                            type: integer
                            description: Процент завершения импорта
                            example: 42
                          report:
                            oneOf:
                              - type: 'null'
                              - type: object
                                properties:
                                  successCount:
                                    type: integer
                                    example: 118
                                  errorCount:
                                    type: integer
                                    example: 2
              examples:
                in_progress:
                  summary: Импорт в процессе
                  value:
                    success: true
                    message: "Processing"
                    data:
                      progress: 42
                      report: null
                completed:
                  summary: Импорт завершён
                  value:
                    success: true
                    message: "Completed"
                    data:
                      progress: 100
                      report:
                        successCount: 118
                        errorCount: 2
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'
        '404':
          $ref: './core/common/responses.yaml#/components/responses/NotFound'

  /user/user/load-template:
    get:
      tags: [Users.Import]
      operationId: downloadUserImportTemplate
      summary: Скачать шаблон Excel для импорта
      description: Возвращает Excel файл с шаблоном для импорта пользователей
      responses:
        '200':
          description: Успешно скачан файл шаблона
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
              examples:
                template:
                  summary: Excel-шаблон для импорта
                  value: "UEsDBBQACAgI..."  # base64 заглушка файла
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'
        '404':
          $ref: './core/common/responses.yaml#/components/responses/NotFound'

# === Отчёты об импорте ===

  /user/import-report/index:
    get:
      tags: [Users.Import]
      operationId: listUserImportReports
      summary: Получить список завершённых отчётов импорта
      description: Возвращает список всех завершенных отчётов импорта пользователей
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Page'
        - $ref: './core/common/parameters.yaml#/components/parameters/PerPage'
      responses:
        '200':
          description: Успешно получен список отчётов импорта
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './core/common/schemas.yaml#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          pagination:
                            $ref: './core/common/schemas.yaml#/components/schemas/PaginationMeta'
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/ImportReport'
              examples:
                reports:
                  summary: Последние отчёты
                  value:
                    success: true
                    data:
                      pagination:
                        total: 2
                        page: 1
                        per_page: 20
                      items:
                        - id: 1201
                          file: "import-users-2025-02-10.xlsx"
                          status: "completed"
                          progress: 100
                          success_count: 98
                          error_count: 2
                          created_at: "2025-02-10T10:00:00Z"
                          updated_at: "2025-02-10T10:05:30Z"
                        - id: 1190
                          file: "import-users-2025-02-08.xlsx"
                          status: "failed"
                          progress: 100
                          success_count: 0
                          error_count: 120
                          created_at: "2025-02-08T08:20:00Z"
                          updated_at: "2025-02-08T08:21:10Z"
        '400':
          $ref: './core/common/responses.yaml#/components/responses/BadRequest'

  /user/importreport/download:
    get:
      tags: [Users.Import]
      operationId: downloadUserImportReport
      summary: Скачать XLSX с результатами импорта
      description: Возвращает Excel файл с детальными результатами импорта
      parameters:
        - $ref: './core/common/parameters.yaml#/components/parameters/Id'
      responses:
        '200':
          description: Успешно скачан файл отчёта импорта
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
              examples:
                report_file:
                  summary: XLSX-отчёт об импорте
                  value: "UEsDBBQACAgI..."  # base64 заглушка Excel
        '404':
          $ref: './core/common/responses.yaml#/components/responses/NotFound'

# ========================================
# Компоненты для Users модуля
# ========================================
components:
  schemas:
    # Request схемы
    UserForm:
      # Используется для multipart/form-data в create/update
      allOf:
        - $ref: '#/components/schemas/CreateUserRequest'
        - type: object
          properties:
            id:
              type: integer
              minimum: 1
              example: 101
              description: ID пользователя (только для update)
            avatar:
              type: string
              format: binary
              description: Аватар пользователя (опционально)

    CreateUserRequest:
      type: object
      required:
        - username
        - email
      properties:
        username:
          type: string
          minLength: 2
          maxLength: 255
          description: |
            Имя пользователя. Обязательное поле.
            - Минимум 2 символа
            - Максимум 255 символов
            - Trim automatically applied
          example: "Иван Петров"
        email:
          type: string
          format: email
          description: |
            Email пользователя. Должен быть уникальным в системе.
            - Trim automatically applied
            - Valid email format required
          example: "ivan.petrov@example.com"
        password:
          type: string
          description: |
            Пароль пользователя. Если не указан, генерируется автоматически.
            - Для существующих сотрудников не требуется
            - Для новых пользователей рекомендуется задавать
          example: "SecurePassword123!"
        role:
          type: string
          description: |
            Роль пользователя в системе. По умолчанию 'user'.
            - Не может быть из списка RESTRICTED_ROLES
            - Доступные роли: superadmin, admin, editor, curator, student
          example: "student"
          enum: [superadmin, admin, editor, curator, student]
        department:
          type: string
          description: |
            Отдел пользователя. Синхронизируется с LMS.
          example: "IT отдел"
        position:
          type: string
          description: |
            Должность пользователя. Синхронизируется с LMS.
          example: "Разработчик"
        phone:
          type: string
          description: |
            Телефон пользователя
          example: "+7 (999) 123-45-67"
        custom_fields:
          type: object
          description: |
            Дополнительные поля пользователя (custom fields)
            Ключи - это имена полей, значения - данные
          example:
            city: "Москва"
            experience: "5 лет"
            skills: ["PHP", "JavaScript", "MySQL"]
        group_ids:
          type: array
          description: Список идентификаторов групп, к которым добавляется пользователь
          items:
            type: integer
            minimum: 1
          example: [12, 34]
        course_ids:
          type: array
          description: Список идентификаторов курсов для назначения
          items:
            type: integer
            minimum: 1
          example: [501, 502]

    # Response схемы
    User:
      type: object
      properties:
        id:
          type: integer
          description: Уникальный идентификатор пользователя
          example: 123
        username:
          type: string
          description: Имя пользователя
          example: "Иван Петров"
        email:
          type: string
          format: email
          description: Email пользователя
          example: "ivan.petrov@example.com"
        role:
          type: string
          description: Роль пользователя
          example: "student"
        status:
          type: string
          description: Статус пользователя
          enum: [active, inactive, blocked]
          example: "active"
        department:
          type: string
          description: Отдел
          example: "IT отдел"
        position:
          type: string
          description: Должность
          example: "Разработчик"
        phone:
          type: string
          description: Телефон
          example: "+7 (999) 123-45-67"
        photo:
          type: string
          format: uri
          description: URL фотографии пользователя (S3)
          example: "https://s3.amazonaws.com/bucket/users/photos/123.jpg"
        created_at:
          type: string
          format: date-time
          description: Дата создания пользователя
          example: "2025-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          description: Дата последнего обновления
          example: "2025-01-15T10:30:00Z"
        last_login_at:
          type: string
          format: date-time
          description: Дата последнего входа
          example: "2025-01-16T09:15:00Z"
        email_verified:
          type: boolean
          description: Подтвержден ли email
          example: true
        custom_fields:
          type: object
          description: Дополнительные поля пользователя
          example:
            city: "Москва"
            experience: "5 лет"

    UserList:
      type: object
      properties:
        data:
          type: object
          properties:
            pagination:
              $ref: './core/common/schemas.yaml#/components/schemas/PaginationMeta'
            items:
              type: array
              items:
                $ref: './core/common/schemas.yaml#/components/schemas/User'
          description: Объект данных с пагинацией и списком

    # Специализированные схемы
    UserImportStatus:
      type: object
      properties:
        id:
          type: integer
          description: ID задачи импорта
          example: 456
        status:
          type: string
          enum: [pending, processing, completed, failed]
          description: Статус обработки
          example: "processing"
        progress:
          type: integer
          minimum: 0
          maximum: 100
          description: Прогресс выполнения в процентах
          example: 75
        total_rows:
          type: integer
          description: Всего строк в файле
          example: 150
        processed_rows:
          type: integer
          description: Обработано строк
          example: 112
        errors:
          type: array
          items:
            type: object
            properties:
              row:
                type: integer
                description: Номер строки с ошибкой
                example: 2
              field:
                type: string
                description: Поле с ошибкой
                example: "email"
              message:
                type: string
                description: Описание ошибки
                example: "Invalid email format"
          description: Массив ошибок валидации
        created_at:
          type: string
          format: date-time
          description: Время создания задачи
          example: "2025-02-10T10:00:00Z"
        completed_at:
          type: string
          format: date-time
          description: Время завершения задачи
          example: "2025-02-10T10:05:00Z"

    ImportReport:
      type: object
      description: Итоговый отчёт завершённого импорта пользователей
      properties:
        id:
          type: integer
          description: ID отчёта импорта
          example: 1201
        file:
          type: string
          description: Имя исходного файла импорта
          example: "import-users-2025-02-10.xlsx"
        status:
          type: string
          enum: [completed, failed]
          description: Финальный статус задачи импорта
          example: completed
        progress:
          type: integer
          minimum: 0
          maximum: 100
          description: Процент завершения задачи (всегда 100 для завершённых отчётов)
          example: 100
        success_count:
          type: integer
          description: Количество успешно обработанных записей
          example: 118
        error_count:
          type: integer
          description: Количество записей с ошибками
          example: 2
        created_at:
          type: string
          format: date-time
          description: Дата создания задачи импорта
          example: "2025-02-10T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: Дата последнего обновления статуса задачи
          example: "2025-02-10T10:05:30Z"

    UserField:
      type: object
      properties:
        id:
          type: integer
          description: ID поля
          example: 789
        name:
          type: string
          description: Имя поля (system name)
          example: "experience_years"
        label:
          type: string
          description: Отображаемое название поля
          example: "Опыт работы (лет)"
        type:
          type: string
          enum: [string, number, date, boolean, select]
          description: Тип поля
          example: "number"
        required:
          type: boolean
          description: Обязательное ли поле
          example: false
        enabled:
          type: boolean
          description: Активно ли поле
          example: true
        validation_rules:
          type: object
          description: Правила валидации
          example:
            min: 0
            max: 50
        options:
          type: array
          items:
            type: string
          description: Варианты для select полей
          example: ["0-1", "2-5", "6-10", "10+"]
    UserStatus:
      type: object
      properties:
        id:
          type: string
          description: Системный код статуса
          example: active
        name:
          type: string
          description: Отображаемое название статуса
          example: Активный
        description:
          type: string
          description: Расширенное описание статуса
          example: Пользователь с активной учётной записью
        category:
          type: string
          description: Группа статусов (например, access, pending, blocked)
          example: access
        color:
          type: string
          description: Цветовой код статуса (hex)
          example: "#2ea44f"
        is_default:
          type: boolean
          description: Является ли статус статусом по умолчанию при создании
          example: true
      example:
        id: active
        name: Активный
        description: Пользователь с полной активной учётной записью
        category: access
        color: "#2ea44f"
        is_default: true
