openapi: 3.1.0
info:
  title: Users Management API
  version: 1.0.0
  description: '## Users Management — 16 методов


    Управление пользователями, ролями, импортом и интеграциями.

    '
servers:
- url: /api/v1
  description: API v1 endpoint
tags:
- name: Users.Operations
  description: '## Базовые операции с пользователями


    **Назначение:** CRUD для пользователей, управление статусами и ролями.

    **Ключевые особенности:**

    - Фильтрация по `status` (int), `role`, `department`.

    - Поддержка кастомных полей в `view` и `update`.

    - Асинхронное создание (через очередь).

    '
- name: Users.Courses
  description: '## Управление курсами пользователя


    **Назначение:** назначение и отзыв курсов.

    **Особенности:** методы `add-course` и `delete-course` работают асинхронно.

    '
- name: Users.Import
  description: '## Импорт пользователей


    **Назначение:** массовая загрузка пользователей из Excel.

    **Процесс:** `load-template` -> `preview` -> `load` (commit) -> `get-import-progress`.

    '
- name: Users.Fields
  description: '## Кастомные поля


    **Назначение:** работа с дополнительными атрибутами профиля (`UserFieldKey`).

    '
paths:
  /user/user/index:
    get:
      tags:
      - Users.Operations
      operationId: listUsers
      summary: Получить список пользователей
      description: 'Возвращает список пользователей с пагинацией и расширенными фильтрами.

        Поддерживает сортировку и фильтрацию по группам, курсам и сумме оплат.

        '
      parameters:
      - $ref: ./core/common/parameters.yaml#/components/parameters/Page
      - $ref: ./core/common/parameters.yaml#/components/parameters/PerPage
      - name: username
        in: query
        schema:
          type: string
        description: Поиск по имени или email
      - name: status
        in: query
        description: 'Статус: 0=New, 10=Active, 20=Blocked, 30=Unconfirmed'
        schema:
          type: integer
          enum:
          - 0
          - 10
          - 20
          - 30
      - name: position
        in: query
        schema:
          type: string
        description: Фильтр по должности
      - name: department
        in: query
        schema:
          type: string
        description: Фильтр по отделу
      - name: groupIds
        in: query
        schema:
          type: array
          items:
            type: integer
        description: Фильтр по ID групп
      - name: courseIds
        in: query
        schema:
          type: array
          items:
            type: integer
        description: Фильтр по ID курсов (имеет доступ)
      - name: sort
        in: query
        schema:
          type: string
          default: -updated_at
          example: -created_at
        description: 'Поле сортировки: username, email, position, department, status, courseCount, created_at, updated_at,
          payment_sum. Префикс ''-'' для убывания.'
      responses:
        '200':
          description: Список пользователей
          content:
            application/json:
              schema:
                allOf:
                - $ref: ./core/common/schemas.yaml#/components/schemas/SuccessResponse
                - type: object
                  properties:
                    data:
                      type: object
                      properties:
                        pagination:
                          $ref: ./core/common/schemas.yaml#/components/schemas/PaginationMeta
                        items:
                          type: array
                          items:
                            $ref: '#/components/schemas/UserListItem'
        '422':
          $ref: ./core/common/responses.yaml#/components/responses/UnprocessableEntity
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
      security:
      - BearerToken: []
  /user/user/admin:
    get:
      tags:
      - Users.Operations
      operationId: listAdminUsers
      summary: Получить список администраторов
      description: Аналогичен методу index, но возвращает только пользователей с правами администратора.
      parameters:
      - $ref: ./core/common/parameters.yaml#/components/parameters/Page
      - $ref: ./core/common/parameters.yaml#/components/parameters/PerPage
      - name: username
        in: query
        description: Поиск по имени или email
        schema:
          type: string
      - name: sort
        in: query
        description: Поле сортировки
        schema:
          type: string
          default: -updated_at
      responses:
        '200':
          description: Список администраторов
          content:
            application/json:
              schema:
                allOf:
                - $ref: ./core/common/schemas.yaml#/components/schemas/SuccessResponse
                - type: object
                  properties:
                    data:
                      type: object
                      properties:
                        pagination:
                          $ref: ./core/common/schemas.yaml#/components/schemas/PaginationMeta
                        items:
                          type: array
                          items:
                            $ref: '#/components/schemas/UserListItem'
        '422':
          $ref: ./core/common/responses.yaml#/components/responses/UnprocessableEntity
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
      security:
      - BearerToken: []
  /user/user/view:
    get:
      tags:
      - Users.Operations
      operationId: getUser
      summary: Получить профиль пользователя
      description: Возвращает детальную информацию о пользователе, включая курсы, сертификаты и кастомные поля.
      parameters:
      - $ref: ./core/common/parameters.yaml#/components/parameters/Id
      responses:
        '200':
          description: Профиль пользователя
          content:
            application/json:
              schema:
                allOf:
                - $ref: ./core/common/schemas.yaml#/components/schemas/SuccessResponse
                - type: object
                  properties:
                    data:
                      type: object
                      properties:
                        item:
                          $ref: '#/components/schemas/UserDetail'
        '404':
          $ref: ./core/common/responses.yaml#/components/responses/NotFound
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
      security:
      - BearerToken: []
  /user/user/create:
    post:
      tags:
      - Users.Operations
      operationId: createUser
      summary: Создать пользователя
      description: 'Создает нового пользователя. Пароль обязателен.

        Привязка к группам и курсам при создании не поддерживается (используйте отдельные методы).

        '
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/UserCreateForm'
      responses:
        '201':
          description: Пользователь успешно создан
          content:
            application/json:
              schema:
                allOf:
                - $ref: ./core/common/schemas.yaml#/components/schemas/SuccessResponse
                - type: object
                  properties:
                    data:
                      type: object
                      properties:
                        user_id:
                          type: integer
                          example: 1
        '422':
          $ref: ./core/common/responses.yaml#/components/responses/UnprocessableEntity
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
      security:
      - BearerToken: []
  /user/user/update:
    put:
      tags:
      - Users.Operations
      operationId: updateUser
      summary: Обновить пользователя
      description: Обновляет данные профиля, включая кастомные поля.
      parameters:
      - $ref: ./core/common/parameters.yaml#/components/parameters/Id
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/UserUpdateForm'
      responses:
        '200':
          description: Пользователь обновлен
          content:
            application/json:
              schema:
                allOf:
                - $ref: ./core/common/schemas.yaml#/components/schemas/SuccessResponse
                - type: object
                  properties:
                    data:
                      type: object
                      properties:
                        user_id:
                          type: integer
                          example: 1
        '422':
          $ref: ./core/common/responses.yaml#/components/responses/UnprocessableEntity
        '403':
          $ref: ./core/common/responses.yaml#/components/responses/Forbidden
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
      security:
      - BearerToken: []
  /user/user/delete:
    delete:
      tags:
      - Users.Operations
      operationId: deleteUser
      summary: Удалить пользователя(ей)
      description: Удаляет одного или нескольких пользователей.
      parameters:
      - name: ids
        in: query
        schema:
          type: array
          items:
            type: integer
        description: Массив ID пользователей для удаления (опционально, если не передано - ошибка?)
      responses:
        '200':
          description: Успешное удаление
          content:
            application/json:
              schema:
                $ref: ./core/common/schemas.yaml#/components/schemas/SuccessResponse
        '401':
          $ref: ./core/common/responses.yaml#/components/responses/Unauthorized
        '403':
          $ref: ./core/common/responses.yaml#/components/responses/Forbidden
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
      security:
      - BearerToken: []
  /dictionary/user/fields:
    get:
      tags:
      - Users.Fields
      operationId: listUserFields
      summary: Получить список кастомных полей
      description: Возвращает конфигурацию дополнительных полей профиля пользователя.
      security:
      - BearerToken: []
      responses:
        '200':
          description: Список полей
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserFieldDefinition'
        '401':
          $ref: ./core/common/responses.yaml#/components/responses/Unauthorized
  /dictionary/user/statuses:
    get:
      tags:
      - Users.Operations
      operationId: listUserStatuses
      summary: Справочник статусов
      description: Возвращает список всех возможных статусов пользователей (New, Active, Blocked, Unconfirmed) с их ID для
        использования в фильтрах и при создании пользователей.
      security:
      - BearerToken: []
      responses:
        '200':
          description: Список статусов
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 1
                        name:
                          type: string
                          example: John Doe
        '401':
          $ref: ./core/common/responses.yaml#/components/responses/Unauthorized
  /user/user/add-course:
    post:
      tags:
      - Users.Courses
      operationId: assignUserCourse
      summary: Назначить курс пользователю
      description: Назначает один или несколько курсов одному или нескольким пользователям. Операция выполняется асинхронно.
        Если пользователь уже имеет доступ к курсу, отметка `new=false` указывает на существующее назначение.
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/AddCourseForm'
      responses:
        '200':
          description: Курс назначен
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        userId:
                          type: integer
                          example: 1
                        courseId:
                          type: integer
                          example: 1
                        result:
                          type: boolean
                          example: true
                        new:
                          type: boolean
                          example: true
        '422':
          $ref: ./core/common/responses.yaml#/components/responses/UnprocessableEntity
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
      security:
      - BearerToken: []
  /user/user/delete-course:
    post:
      tags:
      - Users.Courses
      operationId: deleteUserCourse
      summary: Отозвать курс у пользователя
      description: Удаляет доступ одного или нескольких пользователей к одному или нескольким курсам. После удаления прогресс
        прохождения курса сохраняется, но пользователь больше не может получать доступ к материалам и выполнять задания курса.
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/AddCourseForm'
      responses:
        '200':
          description: Курс отозван
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  results:
                    type: integer
                    description: Количество удаленных записей
                    example: 1
        '422':
          $ref: ./core/common/responses.yaml#/components/responses/UnprocessableEntity
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
      security:
      - BearerToken: []
  /user/user/load-template:
    get:
      tags:
      - Users.Import
      operationId: downloadUserImportTemplate
      summary: Скачать шаблон импорта (XLSX)
      description: Возвращает Excel-шаблон для массового импорта пользователей. Содержит необходимые колонки (username, email,
        password, department, position и др.) с примерами и подсказками. Используйте этот файл как основу для подготовки данных
        к импорту.
      security:
      - BearerToken: []
      responses:
        '200':
          description: Файл шаблона
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
  /user/user/preview:
    post:
      tags:
      - Users.Import
      operationId: getUserImportPreview
      summary: Предварительный просмотр импорта
      description: Валидирует загруженный файл и показывает предварительный просмотр данных, которые будут импортированы.
        Помогает обнаружить ошибки в формате или содержимом перед фактическим импортом. Возвращает список строк и ошибок валидации
        для каждой записи.
      security:
      - BearerToken: []
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                fileImport:
                  type: string
                  format: binary
                  example: example
                updateMode:
                  type: boolean
                  example: true
      responses:
        '200':
          description: Результат превью
          content:
            application/json:
              schema:
                allOf:
                - $ref: ./core/common/schemas.yaml#/components/schemas/SuccessResponse
                - type: object
                  properties:
                    data:
                      type: object
                      properties:
                        preview:
                          type: object
                          description: Структура превью (строки, ошибки)
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
  /user/user/load:
    post:
      tags:
      - Users.Import
      operationId: createUserImport
      summary: Запустить импорт
      description: Запускает асинхронный процесс импорта пользователей из загруженного файла. Возвращает `jobId` для отслеживания
        прогресса и `reportKey` для получения результатов. Используйте метод `get-import-progress` для мониторинга и получения
        финального отчета.
      security:
      - BearerToken: []
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                fileImport:
                  type: string
                  format: binary
                  example: example
                updateMode:
                  type: boolean
                  example: true
      responses:
        '200':
          description: Задача создана
          content:
            application/json:
              schema:
                allOf:
                - $ref: ./core/common/schemas.yaml#/components/schemas/SuccessResponse
                - type: object
                  properties:
                    data:
                      type: object
                      properties:
                        jobId:
                          type: integer
                          example: 1
                        reportKey:
                          type: string
                          example: example
        '422':
          $ref: ./core/common/responses.yaml#/components/responses/UnprocessableEntity
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
  /user/user/get-import-progress:
    get:
      tags:
      - Users.Import
      operationId: getUserImportProgress
      summary: Получить прогресс импорта
      description: Возвращает текущий статус и прогресс импорта пользователей. Параметр `id` должен содержать `reportKey`
        из ответа метода `load`. По завершении импорта включает финальный отчет с результатами (количество успешно импортированных,
        ошибки, предупреждения).
      security:
      - BearerToken: []
      parameters:
      - name: id
        in: query
        required: true
        schema:
          type: string
        description: Report Key из метода load
      responses:
        '200':
          description: Прогресс
          content:
            application/json:
              schema:
                allOf:
                - $ref: ./core/common/schemas.yaml#/components/schemas/SuccessResponse
                - type: object
                  properties:
                    data:
                      type: object
                      properties:
                        progress:
                          type: integer
                          example: 1
                        report:
                          type:
                          - object
                          - 'null'
        '404':
          $ref: ./core/common/responses.yaml#/components/responses/NotFound
  /user/import-report/index:
    get:
      tags:
      - Users.Import
      operationId: listUserImportReports
      summary: История импортов
      description: Возвращает список всех выполненных импортов пользователей с пагинацией. Каждый отчет содержит информацию
        о дате импорта, количестве обработанных записей, количестве ошибок и результатах. Используйте метод `downloadUserImportReport`
        для получения детального отчета в формате Excel.
      security:
      - BearerToken: []
      parameters:
      - $ref: ./core/common/parameters.yaml#/components/parameters/Page
      - $ref: ./core/common/parameters.yaml#/components/parameters/PerPage
      - name: type
        in: query
        schema:
          type: integer
        description: Фильтр по типу отчета
      responses:
        '200':
          description: Список отчетов
          content:
            application/json:
              schema:
                allOf:
                - $ref: ./core/common/schemas.yaml#/components/schemas/SuccessResponse
                - type: object
                  properties:
                    data:
                      type: object
                      properties:
                        pagination:
                          $ref: ./core/common/schemas.yaml#/components/schemas/PaginationMeta
                        items:
                          type: array
                          items:
                            $ref: '#/components/schemas/ImportReport'
        '422':
          $ref: ./core/common/responses.yaml#/components/responses/UnprocessableEntity
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
  /user/importreport/download:
    get:
      tags:
      - Users.Import
      operationId: downloadUserImportReport
      summary: Скачать отчет об импорте
      description: Возвращает детальный отчет об импорте в формате Excel. Отчет содержит информацию о каждой обработанной
        строке (успех/ошибка), данные пользователя и результат обработки. Используйте ID отчета из метода `listUserImportReports`.
      security:
      - BearerToken: []
      parameters:
      - name: id
        in: query
        description: ID отчета об импорте
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Файл отчета
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '500':
          $ref: ./core/common/responses.yaml#/components/responses/InternalError
components:
  schemas:
    UserListItem:
      type: object
      properties:
        id:
          type: integer
          example: 1
        username:
          type: string
          example: john_doe
        email:
          type: string
          example: user@example.com
        department:
          type:
          - string
          - 'null'
          example: Marketing
        position:
          type:
          - string
          - 'null'
          example: Manager
        photo:
          type:
          - string
          - 'null'
          example: https://example.com/photo.jpg
        status:
          type: integer
          description: 0=New, 10=Active, 20=Blocked, 30=Unconfirmed
          example: 10
        created_at:
          type: integer
          example: 1699459200
        updated_at:
          type: integer
          example: 1699459200
        role:
          type: string
          example: admin
        educationAccess:
          type: boolean
          example: true
        courseCount:
          type: integer
          example: 5
        payment_sum:
          type: number
          example: 2999.99
        groups:
          type: array
          items:
            $ref: ./groups.yaml#/components/schemas/Group
    UserDetail:
      allOf:
      - $ref: '#/components/schemas/UserListItem'
      - type: object
        properties:
          phone:
            type:
            - string
            - 'null'
            example: '+79991234567'
          waitRequest:
            type: array
            items:
              type: object
          certificates:
            type: array
            items:
              $ref: ./certificates.yaml#/components/schemas/Certificate
          courses:
            type: array
            items:
              type: object
              properties:
                id:
                  type: integer
                  example: 1
                title:
                  type: string
                  example: example
                status:
                  type: integer
                  example: 10
                progress:
                  type: number
                  example: 75.5
                amount:
                  type: number
                  example: 2999.99
                group:
                  type:
                  - string
                  - 'null'
                  example: Group 1
          userFields:
            type: array
            items:
              $ref: '#/components/schemas/UserFieldDefinition'
    UserFieldDefinition:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          description: System name (key)
          example: John Doe
        title:
          type: string
          description: Display name
          example: Advanced Python
        type:
          type: integer
          description: Field type code
          example: 1
    UserCreateForm:
      type: object
      required:
      - username
      - email
      - password
      properties:
        username:
          type: string
          description: Уникальное имя пользователя
          example: john_doe
        email:
          type: string
          format: email
          description: Электронная почта (должна быть уникальной)
          example: user@example.com
        password:
          type: string
          description: Пароль пользователя
          example: example
        role:
          type: string
          description: Роль пользователя (admin, user и т.д.)
          example: admin
        department:
          type: string
          description: Отдел или подразделение
          example: Marketing
        position:
          type: string
          description: Должность пользователя
          example: Manager
    UserUpdateForm:
      type: object
      properties:
        username:
          type: string
          description: Уникальное имя пользователя
          example: john_doe
        email:
          type: string
          description: Электронная почта (должна быть уникальной)
          example: user@example.com
        department:
          type: string
          description: Отдел или подразделение
          example: Marketing
        position:
          type: string
          description: Должность пользователя
          example: Manager
        password:
          type: string
          description: Пароль пользователя (оставьте пустым, чтобы не менять)
          example: example
        role:
          type: string
          description: Роль пользователя (admin, user и т.д.)
          example: admin
    AddCourseForm:
      type: object
      required:
      - userIds
      - courses
      properties:
        userIds:
          type: array
          items:
            type: integer
        courses:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                example: 1
              learning_group_id:
                type: integer
                example: 1
    ImportReport:
      type: object
      description: Отчет об импорте пользователей
      properties:
        id:
          type: integer
          example: 1
          description: ID отчета
        filename:
          type: string
          example: users_import.xlsx
          description: Имя загруженного файла
        total_rows:
          type: integer
          example: 150
          description: Общее количество строк в файле
        processed_rows:
          type: integer
          example: 145
          description: Количество успешно обработанных строк
        error_rows:
          type: integer
          example: 5
          description: Количество ошибок при обработке
        status:
          type: string
          example: completed
          description: Статус импорта (processing, completed, failed)
        created_at:
          type: integer
          example: 1699459200
          description: Дата создания отчета (Unix timestamp)
        updated_at:
          type: integer
          example: 1699545600
          description: Дата последнего обновления (Unix timestamp)
  securitySchemes:
    BearerToken:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT Bearer token for authentication
